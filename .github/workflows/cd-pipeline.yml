name: CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write
  id-token: write

env:
  DOTNET_VERSION: '9.0.x'
  AZURE_RESOURCE_GROUP: 'CleverSyncSOS-rg'
  AZURE_LOCATION: 'eastus'
  FUNCTION_APP_NAME: 'cleversync-fn'
  BICEP_FILE: 'infra/main.bicep'

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore CleverSyncSOS.sln

    - name: Build solution
      run: dotnet build CleverSyncSOS.sln --configuration Release --no-restore

    - name: Run unit tests
      run: dotnet test tests/CleverSyncSOS.Core.Tests/CleverSyncSOS.Core.Tests.csproj --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"

    - name: Run integration tests
      run: dotnet test tests/CleverSyncSOS.Integration.Tests/CleverSyncSOS.Integration.Tests.csproj --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=integration-test-results.trx"

    - name: Publish test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results
        path: '**/*.trx'
        reporter: dotnet-trx
        fail-on-error: true

    - name: Publish Azure Functions app
      run: dotnet publish src/CleverSyncSOS.Functions/CleverSyncSOS.Functions.csproj --configuration Release --output ./publish/functions --no-build

    - name: Upload Functions artifact
      uses: actions/upload-artifact@v4
      with:
        name: functions-app
        path: ./publish/functions
        retention-days: 1

  # Job 2: Deploy Infrastructure (only on push to master)
  deploy-infrastructure:
    name: Deploy Azure Infrastructure
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    outputs:
      functionAppName: ${{ steps.deploy-bicep.outputs.functionAppName }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create Resource Group
      run: |
        az group create \
          --name ${{ env.AZURE_RESOURCE_GROUP }} \
          --location ${{ env.AZURE_LOCATION }}

    - name: Deploy Bicep template
      id: deploy-bicep
      run: |
        deployment_output=$(az deployment group create \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --template-file ${{ env.BICEP_FILE }} \
          --parameters prefix=cleversync \
          --query properties.outputs \
          --output json)

        echo "Deployment outputs: $deployment_output"

        functionAppName=$(echo $deployment_output | jq -r '.functionAppDefaultHostName.value')
        echo "functionAppName=$functionAppName" >> $GITHUB_OUTPUT

    - name: Verify deployment
      run: |
        az functionapp show \
          --name ${{ env.FUNCTION_APP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

  # Job 3: Deploy Application (only on push to master, after infrastructure)
  deploy-application:
    name: Deploy Azure Functions
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy-infrastructure]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
    - name: Download Functions artifact
      uses: actions/download-artifact@v4
      with:
        name: functions-app
        path: ./functions-app

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Azure Functions
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.FUNCTION_APP_NAME }}
        package: ./functions-app

    - name: Verify deployment health
      run: |
        echo "Waiting for function app to warm up..."
        sleep 30

        # Get the function app URL
        functionUrl="https://${{ env.FUNCTION_APP_NAME }}.azurewebsites.net/api/health"

        echo "Checking health endpoint: $functionUrl"

        # Try to hit the health endpoint (if it exists)
        curl -f $functionUrl || echo "Health endpoint not available or app still warming up"

    - name: Azure Logout
      if: always()
      run: az logout

  # Job 4: Smoke Tests (optional, only after deployment)
  smoke-tests:
    name: Post-Deployment Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-application
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Check Function App Status
      run: |
        status=$(az functionapp show \
          --name ${{ env.FUNCTION_APP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --query state \
          --output tsv)

        if [ "$status" != "Running" ]; then
          echo "Function App is not running. Status: $status"
          exit 1
        fi

        echo "Function App is running successfully"

    - name: List deployed functions
      run: |
        az functionapp function list \
          --name ${{ env.FUNCTION_APP_NAME }} \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --output table

    - name: Azure Logout
      if: always()
      run: az logout
