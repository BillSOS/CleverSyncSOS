@page "/events-check"
@attribute [Authorize(Policy = "SuperAdmin")]
@using CleverSyncSOS.AdminPortal.Services
@using CleverSyncSOS.Core.Database.SessionDb
@using CleverSyncSOS.Core.Database.SessionDb.Entities
@using Microsoft.EntityFrameworkCore
@inject IEventsCheckService EventsCheckService
@inject ICurrentUserService CurrentUserService
@inject IDbContextFactory<SessionDbContext> DbContextFactory
@inject ILogger<EventsCheck> Logger

<PageTitle>Clever Events Check - CleverSync Admin</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <img src="favicon.png" alt="CleverSync Logo" style="height: 2.5rem; margin-right: 1rem;" />
            <h1 class="mb-0">Clever Events Check</h1>
        </div>
        <button class="btn btn-primary" @onclick="CheckEventsNow" disabled="@_checking">
            @if (_checking)
            {
                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                <span>Checking...</span>
            }
            else
            {
                <i class="oi oi-cloud-download"></i>
                <span> Check Events Now</span>
            }
        </button>
    </div>

    <div class="alert alert-info mb-4">
        <h5 class="alert-heading">How to Use This Page</h5>
        <p class="mb-1">After uploading modified CSV files to Clever:</p>
        <ol class="mb-0">
            <li>Click "Check Events Now" to query the Clever Events API</li>
            <li>If events are found, your changes have been processed by Clever</li>
            <li>You can then trigger a Manual Sync to pull the changes into your database</li>
        </ol>
    </div>

    @if (_latestCheck != null)
    {
        <!-- Latest Check Result -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card border-@GetStatusColor(_latestCheck)">
                    <div class="card-header bg-@GetStatusColor(_latestCheck) bg-opacity-10">
                        <h5 class="mb-0">
                            <span class="badge bg-@GetStatusColor(_latestCheck)">
                                @GetStatusText(_latestCheck)
                            </span>
                            Latest Check Result
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-muted small">Checked At</div>
                                <div class="fw-bold">@ToLocalTimeString(_latestCheck.CheckedAt)</div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-muted small">Checked By</div>
                                <div class="fw-bold">@(_latestCheck.CheckedBy ?? "System")</div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-muted small">API Accessible</div>
                                <div class="fw-bold">@(_latestCheck.ApiAccessible ? "Yes" : "No")</div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-muted small">Events Found</div>
                                <div class="fw-bold fs-4 @(_latestCheck.EventCount > 0 ? "text-success" : "text-muted")">
                                    @_latestCheck.EventCount
                                </div>
                            </div>
                        </div>

                        @if (_latestCheck.EventCount > 0)
                        {
                            <hr />
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="text-muted small">Created Events</div>
                                    <div class="fw-bold text-success">@_latestCheck.CreatedCount</div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-muted small">Updated Events</div>
                                    <div class="fw-bold text-warning">@_latestCheck.UpdatedCount</div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-muted small">Deleted Events</div>
                                    <div class="fw-bold text-danger">@_latestCheck.DeletedCount</div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-muted small">Latest Event ID</div>
                                    <div class="fw-bold text-truncate" title="@_latestCheck.LatestEventId">
                                        @(_latestCheck.LatestEventId?.Substring(0, Math.Min(12, _latestCheck.LatestEventId?.Length ?? 0)))...
                                    </div>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(_latestCheck.ObjectTypeSummary))
                            {
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="text-muted small">Object Types Affected</div>
                                        <div class="fw-bold">@_latestCheck.ObjectTypeSummary</div>
                                    </div>
                                </div>
                            }

                            @if (_latestCheck.EarliestEventTime.HasValue && _latestCheck.LatestEventTime.HasValue)
                            {
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="text-muted small">Earliest Event Time</div>
                                        <div class="fw-bold">@ToLocalTimeString(_latestCheck.EarliestEventTime)</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="text-muted small">Latest Event Time</div>
                                        <div class="fw-bold">@ToLocalTimeString(_latestCheck.LatestEventTime)</div>
                                    </div>
                                </div>
                            }

                            <div class="mt-4">
                                <a href="/sync" class="btn btn-success">
                                    <i class="oi oi-loop-circular"></i> Go to Manual Sync
                                </a>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(_latestCheck.ErrorMessage))
                        {
                            <div class="alert alert-danger mt-3 mb-0">
                                <strong>Error:</strong> @_latestCheck.ErrorMessage
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Event Baseline Status -->
    <div class="card mb-4">
        <div class="card-header bg-info bg-opacity-10">
            <h5 class="mb-0">
                <i class="oi oi-flag"></i> Event Baseline Status
            </h5>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">
                The event baseline determines where incremental syncs start processing. Once initialized,
                future syncs will only process events that occurred <strong>after</strong> the baseline,
                making syncs faster and more efficient.
            </p>

            @if (_loadingBaseline)
            {
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <span class="ms-2">Loading baseline status...</span>
                </div>
            }
            else if (_schools == null || _schools.Count == 0)
            {
                <div class="alert alert-warning mb-0">No active schools found.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>School</th>
                                <th>Baseline Status</th>
                                <th>Last Event ID</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var school in _schools)
                            {
                                var hasBaseline = _baselineStatus.TryGetValue(school.SchoolId, out var eventId) && !string.IsNullOrEmpty(eventId);
                                <tr>
                                    <td>@school.Name</td>
                                    <td>
                                        @if (hasBaseline)
                                        {
                                            <span class="badge bg-success">Initialized</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark">Not Set</span>
                                        }
                                    </td>
                                    <td class="text-truncate" style="max-width: 150px;" title="@eventId">
                                        @(hasBaseline ? $"{eventId?.Substring(0, Math.Min(12, eventId?.Length ?? 0))}..." : "-")
                                    </td>
                                    <td>
                                        <button class="btn btn-sm @(hasBaseline ? "btn-outline-secondary" : "btn-primary")"
                                                @onclick="() => InitializeBaseline(school.SchoolId)"
                                                disabled="@_initializingBaseline">
                                            @if (_initializingBaseline && _initializingSchoolId == school.SchoolId)
                                            {
                                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                            }
                                            else
                                            {
                                                <span>@(hasBaseline ? "Reset Baseline" : "Initialize Baseline")</span>
                                            }
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

            @if (!string.IsNullOrEmpty(_baselineMessage))
            {
                <div class="alert @(_baselineSuccess ? "alert-success" : "alert-danger") mt-3 mb-0">
                    @_baselineMessage
                </div>
            }
        </div>
    </div>

    <!-- Check History -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Check History</h5>
            <button class="btn btn-sm btn-outline-secondary" @onclick="LoadHistory">
                <i class="oi oi-reload"></i> Refresh
            </button>
        </div>
        <div class="card-body">
            @if (_loadingHistory)
            {
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
            else if (_history == null || _history.Count == 0)
            {
                <div class="text-center py-4 text-muted">
                    <p>No check history yet. Click "Check Events Now" to start.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Checked At</th>
                                <th>Checked By</th>
                                <th>API Status</th>
                                <th>Events</th>
                                <th>Created</th>
                                <th>Updated</th>
                                <th>Deleted</th>
                                <th>Object Types</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var check in _history)
                            {
                                <tr class="@(check.EventCount > 0 ? "table-success" : "")">
                                    <td>@ToLocalTimeString(check.CheckedAt)</td>
                                    <td>@(check.CheckedBy ?? "System")</td>
                                    <td>
                                        @if (check.ApiAccessible)
                                        {
                                            <span class="badge bg-success">Accessible</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger" title="@check.ErrorMessage">Error</span>
                                        }
                                    </td>
                                    <td class="fw-bold @(check.EventCount > 0 ? "text-success" : "")">
                                        @check.EventCount
                                    </td>
                                    <td>@check.CreatedCount</td>
                                    <td>@check.UpdatedCount</td>
                                    <td>@check.DeletedCount</td>
                                    <td class="text-truncate" style="max-width: 200px;" title="@check.ObjectTypeSummary">
                                        @check.ObjectTypeSummary
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private EventsLog? _latestCheck;
    private List<EventsLog>? _history;
    private bool _checking;
    private bool _loadingHistory;

    // Baseline status
    private List<School>? _schools;
    private Dictionary<int, string?> _baselineStatus = new();
    private bool _loadingBaseline;
    private bool _initializingBaseline;
    private int _initializingSchoolId;
    private string? _baselineMessage;
    private bool _baselineSuccess;

    // Time zone for displaying local times
    private TimeZoneInfo? _localTimeZone;
    private string _timeZoneAbbreviation = "";

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadHistory(), LoadBaselineStatus(), LoadTimeZone());
    }

    private async Task LoadTimeZone()
    {
        try
        {
            await using var dbContext = await DbContextFactory.CreateDbContextAsync();
            var district = await dbContext.Districts.FirstOrDefaultAsync();
            if (district != null && !string.IsNullOrEmpty(district.LocalTimeZone))
            {
                try
                {
                    _localTimeZone = TimeZoneInfo.FindSystemTimeZoneById(district.LocalTimeZone);
                    // Get abbreviation (e.g., "EST" or "EDT")
                    _timeZoneAbbreviation = GetTimeZoneAbbreviation(_localTimeZone);
                }
                catch (TimeZoneNotFoundException)
                {
                    Logger.LogWarning("Time zone '{TimeZone}' not found, using server local time", district.LocalTimeZone);
                    _localTimeZone = TimeZoneInfo.Local;
                    _timeZoneAbbreviation = GetTimeZoneAbbreviation(_localTimeZone);
                }
            }
            else
            {
                _localTimeZone = TimeZoneInfo.Local;
                _timeZoneAbbreviation = GetTimeZoneAbbreviation(_localTimeZone);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load time zone");
            _localTimeZone = TimeZoneInfo.Local;
            _timeZoneAbbreviation = GetTimeZoneAbbreviation(_localTimeZone);
        }
    }

    private string ToLocalTimeString(DateTime utcTime)
    {
        if (_localTimeZone == null)
            return utcTime.ToLocalTime().ToString("g");

        var localTime = TimeZoneInfo.ConvertTimeFromUtc(utcTime, _localTimeZone);
        return $"{localTime:g} {_timeZoneAbbreviation}";
    }

    private string ToLocalTimeString(DateTime? utcTime)
    {
        if (!utcTime.HasValue)
            return "-";
        return ToLocalTimeString(utcTime.Value);
    }

    private static string GetTimeZoneAbbreviation(TimeZoneInfo tz)
    {
        // Check if we're in daylight saving time
        var now = DateTime.UtcNow;
        var isDaylight = tz.IsDaylightSavingTime(now);

        // Common abbreviations
        if (tz.Id == "Eastern Standard Time")
            return isDaylight ? "EDT" : "EST";
        if (tz.Id == "Central Standard Time")
            return isDaylight ? "CDT" : "CST";
        if (tz.Id == "Mountain Standard Time")
            return isDaylight ? "MDT" : "MST";
        if (tz.Id == "Pacific Standard Time")
            return isDaylight ? "PDT" : "PST";

        // Fallback: use the standard/daylight name abbreviation
        var name = isDaylight ? tz.DaylightName : tz.StandardName;
        // Try to extract initials (e.g., "Eastern Daylight Time" -> "EDT")
        var words = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (words.Length >= 2)
            return string.Concat(words.Select(w => w[0]));

        return name;
    }

    private async Task LoadHistory()
    {
        _loadingHistory = true;
        try
        {
            _history = await EventsCheckService.GetRecentChecksAsync(20);
            _latestCheck = _history?.FirstOrDefault();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load events check history");
        }
        finally
        {
            _loadingHistory = false;
        }
    }

    private async Task LoadBaselineStatus()
    {
        _loadingBaseline = true;
        try
        {
            await using var dbContext = await DbContextFactory.CreateDbContextAsync();
            _schools = await dbContext.Schools
                .Where(s => s.IsActive)
                .OrderBy(s => s.Name)
                .ToListAsync();

            _baselineStatus = await EventsCheckService.GetEventBaselineStatusAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load baseline status");
        }
        finally
        {
            _loadingBaseline = false;
        }
    }

    private async Task InitializeBaseline(int schoolId)
    {
        _initializingBaseline = true;
        _initializingSchoolId = schoolId;
        _baselineMessage = null;
        StateHasChanged();

        try
        {
            var userName = CurrentUserService.UserName;
            var eventId = await EventsCheckService.InitializeEventBaselineAsync(schoolId, userName);

            if (!string.IsNullOrEmpty(eventId))
            {
                _baselineMessage = $"Baseline initialized successfully! Event ID: {eventId.Substring(0, Math.Min(20, eventId.Length))}... Future incremental syncs will start from this point.";
                _baselineSuccess = true;
            }
            else
            {
                _baselineMessage = "Baseline initialized, but no events exist yet. Incremental syncs will use timestamp-based change detection until events are generated.";
                _baselineSuccess = true;
            }

            // Refresh baseline status
            _baselineStatus = await EventsCheckService.GetEventBaselineStatusAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to initialize baseline for school {SchoolId}", schoolId);
            _baselineMessage = $"Failed to initialize baseline: {ex.Message}";
            _baselineSuccess = false;
        }
        finally
        {
            _initializingBaseline = false;
            _initializingSchoolId = 0;
            StateHasChanged();
        }
    }

    private async Task CheckEventsNow()
    {
        _checking = true;
        StateHasChanged();

        try
        {
            var userName = CurrentUserService.UserName;
            _latestCheck = await EventsCheckService.CheckAndLogEventsAsync(userName);

            // Refresh history to show new entry
            _history = await EventsCheckService.GetRecentChecksAsync(20);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to check events");
        }
        finally
        {
            _checking = false;
        }
    }

    private string GetStatusColor(EventsLog check)
    {
        if (!check.ApiAccessible)
            return "danger";
        if (check.EventCount > 0)
            return "success";
        return "warning";
    }

    private string GetStatusText(EventsLog check)
    {
        if (!check.ApiAccessible)
            return "API Error";
        if (check.EventCount > 0)
            return "Events Available";
        return "No Events";
    }
}
