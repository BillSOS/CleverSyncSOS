@page "/sync"
@attribute [Authorize(Policy = "SchoolAdmin")]
@using CleverSyncSOS.Core.Database.SessionDb
@using CleverSyncSOS.Core.Database.SessionDb.Entities
@using CleverSyncSOS.AdminPortal.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.SignalR.Client
@implements IAsyncDisposable
@inject IDbContextFactory<SessionDbContext> DbContextFactory
@inject SessionDbContext DbContext
@inject ICurrentUserService CurrentUser
@inject NavigationManager NavigationManager
@inject ILogger<Sync> Logger
@inject IHttpContextAccessor HttpContextAccessor

<PageTitle>Sync Operations - CleverSync Admin</PageTitle>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <img src="favicon.png" alt="CleverSync Logo" style="height: 2.5rem; margin-right: 1rem;" />
            <h1 class="mb-0">Sync Operations</h1>
            <a href="/help/sync" class="help-link ms-2"
               data-bs-toggle="tooltip" data-bs-placement="bottom"
               title="Learn about sync operations, statuses, and troubleshooting">
                <i class="oi oi-question-mark"></i>
            </a>
        </div>
        <div>
            <button class="btn btn-success me-2" @onclick="StartManualSync">
                <i class="oi oi-loop-circular"></i> Start Manual Sync
            </button>
            <button class="btn btn-primary" @onclick="RefreshData">
                <i class="oi oi-reload"></i> Refresh
            </button>
        </div>
    </div>

    @if (_loading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading sync operations...</p>
        </div>
    }
    else if (_error != null)
    {
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Error</h4>
            <p>@_error</p>
            <button class="btn btn-sm btn-outline-danger" @onclick="LoadData">Try Again</button>
        </div>
    }
    else
    {
        <!-- Orphaned Syncs Warning -->
        @if (_orphanedSyncCount > 0 && CurrentUser.IsSuperAdmin)
        {
            <div class="alert alert-danger mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong><i class="oi oi-warning me-2"></i>@_orphanedSyncCount Orphaned Sync(s) Detected</strong>
                        <p class="mb-0 mt-1">
                            These syncs show "In Progress" but have no active lock, indicating they crashed or failed without updating their status.
                        </p>
                    </div>
                    <button class="btn btn-danger" @onclick="MarkAllOrphanedAsFailed">
                        <i class="oi oi-x me-1"></i> Mark All as Failed
                    </button>
                </div>
            </div>
        }

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Total Syncs</h6>
                        <h3 class="card-title">@_syncHistory.Count</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Successful</h6>
                        <h3 class="card-title text-success">@_syncHistory.Count(s => s.Status == "Success")</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Failed</h6>
                        <h3 class="card-title text-danger">@_syncHistory.Count(s => s.Status == "Failed")</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">In Progress</h6>
                        <h3 class="card-title text-warning">@_syncHistory.Count(s => s.Status == "InProgress")</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    @if (CurrentUser.IsSuperAdmin || CurrentUser.IsDistrictAdmin)
                    {
                        <div class="col-md-3">
                            <label class="form-label">School</label>
                            <select class="form-select" @bind="_selectedSchoolId" @bind:after="FilterData">
                                <option value="0">All Schools</option>
                                @foreach (var school in _schools)
                                {
                                    <option value="@school.SchoolId">@school.Name</option>
                                }
                            </select>
                        </div>
                    }
                    <div class="col-md-3">
                        <label class="form-label">Entity Type</label>
                        <select class="form-select" @bind="_selectedEntityType" @bind:after="FilterData">
                            <option value="">All Types</option>
                            <option value="Student">Student</option>
                            <option value="Teacher">Teacher</option>
                            <option value="Section">Section</option>
                            <option value="Admin">Admin</option>
                            <option value="Event">Event</option>
                            <option value="Workshop">Workshop</option>
                            <option value="Baseline">Baseline</option>
                            <option value="Course">Course</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Sync Type</label>
                        <select class="form-select" @bind="_selectedSyncType" @bind:after="FilterData">
                            <option value="">All Types</option>
                            <option value="@SyncType.Incremental">Incremental</option>
                            <option value="@SyncType.Full">Full</option>
                            <option value="@SyncType.Reconciliation">Reconciliation</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" @bind="_selectedStatus" @bind:after="FilterData">
                            <option value="">All Statuses</option>
                            <option value="Success">Success</option>
                            <option value="Failed">Failed</option>
                            <option value="Partial">Partial</option>
                            <option value="InProgress">In Progress</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sync History Table -->
        @if (_filteredSyncHistory == null || !_filteredSyncHistory.Any())
        {
            <div class="alert alert-info" role="alert">
                <h4 class="alert-heading">No Sync Operations Found</h4>
                <p>No sync operations match the current filters.</p>
            </div>
        }
        else
        {
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Recent Sync Operations</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Start Time</th>
                                    <th>School</th>
                                    <th>Entity Type</th>
                                    <th>Sync Type</th>
                                    <th>Status</th>
                                    <th>Records</th>
                                    <th>Duration</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var sync in GetPagedData())
                                {
                                    <tr>
                                        <td>
                                            <span class="text-nowrap">@FormatLocalTime(sync.SyncStartTime, sync.School?.District?.LocalTimeZone)</span>
                                        </td>
                                        <td>
                                            <strong>@sync.School?.Name</strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">@sync.EntityType</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">@sync.SyncType</span>
                                        </td>
                                        <td>
                                            @if (sync.Status == "Success")
                                            {
                                                <span class="badge bg-success">Success</span>
                                            }
                                            else if (sync.Status == "Failed")
                                            {
                                                <span class="badge bg-danger">Failed</span>
                                            }
                                            else if (sync.Status == "InProgress")
                                            {
                                                @if (IsOrphanedSync(sync))
                                                {
                                                    <span class="badge bg-danger">Orphaned</span>
                                                    @if (CurrentUser.IsSuperAdmin)
                                                    {
                                                        var syncToMark = sync;
                                                        <button class="btn btn-sm btn-outline-danger ms-1"
                                                                @onclick="async () => await MarkSyncAsFailed(syncToMark)"
                                                                @onclick:stopPropagation="true"
                                                                title="Mark as Failed">
                                                            <i class="oi oi-x"></i>
                                                        </button>
                                                    }
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning text-dark">In Progress</span>
                                                }
                                            }
                                            else if (sync.Status == "Partial")
                                            {
                                                <span class="badge bg-warning text-dark">Partial</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">@sync.Status</span>
                                            }
                                        </td>
                                        <td>
                                            <span class="text-muted">@sync.RecordsProcessed processed</span>
                                            <br/>
                                            <span class="text-success">@sync.RecordsUpdated updated</span>
                                            @if (sync.RecordsFailed > 0)
                                            {
                                                <br/>
                                                <span class="text-danger">@sync.RecordsFailed failed</span>
                                            }
                                        </td>
                                        <td>
                                            @if (sync.SyncEndTime.HasValue)
                                            {
                                                var duration = sync.SyncEndTime.Value - sync.SyncStartTime;
                                                <span class="text-muted">@FormatDuration(duration)</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" @onclick="() => ViewDetails(sync)" title="View Details">
                                                <i class="oi oi-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- FR-004: Pagination Controls (50 records per page) -->
                    <div class="mt-3 d-flex justify-content-between align-items-center">
                        <div class="text-muted">
                            Showing @GetStartRecord()-@GetEndRecord() of @_filteredSyncHistory.Count sync operation@(_filteredSyncHistory.Count != 1 ? "s" : "")
                        </div>

                        @if (TotalPages > 1)
                        {
                            <nav aria-label="Sync history pagination">
                                <ul class="pagination mb-0">
                                    <li class="page-item @(_currentPage == 1 ? "disabled" : "")">
                                        <button class="page-link" @onclick="GoToFirstPage" disabled="@(_currentPage == 1)">
                                            <i class="oi oi-media-skip-backward"></i>
                                        </button>
                                    </li>
                                    <li class="page-item @(_currentPage == 1 ? "disabled" : "")">
                                        <button class="page-link" @onclick="GoToPreviousPage" disabled="@(_currentPage == 1)">
                                            <i class="oi oi-chevron-left"></i> Previous
                                        </button>
                                    </li>

                                    @foreach (var pageNum in GetPageNumbers())
                                    {
                                        <li class="page-item @(_currentPage == pageNum ? "active" : "")">
                                            <button class="page-link" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                                        </li>
                                    }

                                    <li class="page-item @(_currentPage == TotalPages ? "disabled" : "")">
                                        <button class="page-link" @onclick="GoToNextPage" disabled="@(_currentPage == TotalPages)">
                                            Next <i class="oi oi-chevron-right"></i>
                                        </button>
                                    </li>
                                    <li class="page-item @(_currentPage == TotalPages ? "disabled" : "")">
                                        <button class="page-link" @onclick="GoToLastPage" disabled="@(_currentPage == TotalPages)">
                                            <i class="oi oi-media-skip-forward"></i>
                                        </button>
                                    </li>
                                </ul>
                            </nav>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Details Modal -->
        @if (_showDetailsModal && _selectedSync != null)
        {
            <div class="modal show d-block" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Sync Operation Details</h5>
                            <button type="button" class="btn-close" @onclick="CloseDetailsModal"></button>
                        </div>
                        <div class="modal-body">
                            <dl class="row">
                                <dt class="col-sm-3">Sync ID:</dt>
                                <dd class="col-sm-9">@_selectedSync.SyncId</dd>

                                <dt class="col-sm-3">School:</dt>
                                <dd class="col-sm-9">@_selectedSync.School?.Name</dd>

                                <dt class="col-sm-3">Entity Type:</dt>
                                <dd class="col-sm-9">@_selectedSync.EntityType</dd>

                                <dt class="col-sm-3">Sync Type:</dt>
                                <dd class="col-sm-9">@_selectedSync.SyncType</dd>

                                <dt class="col-sm-3">Status:</dt>
                                <dd class="col-sm-9">@_selectedSync.Status</dd>

                                <dt class="col-sm-3">Start Time:</dt>
                                <dd class="col-sm-9">@FormatLocalTime(_selectedSync.SyncStartTime, _selectedSync.School?.District?.LocalTimeZone, "F")</dd>

                                <dt class="col-sm-3">End Time:</dt>
                                <dd class="col-sm-9">@(_selectedSync.SyncEndTime.HasValue ? FormatLocalTime(_selectedSync.SyncEndTime.Value, _selectedSync.School?.District?.LocalTimeZone, "F") : "Not completed")</dd>

                                <dt class="col-sm-3">Records Processed:</dt>
                                <dd class="col-sm-9">
                                    <strong>@_selectedSync.RecordsProcessed @GetEntityTypeLabel(_selectedSync.EntityType)</strong>
                                    <small class="text-muted ms-2">(fetched from Clever and examined)</small>
                                </dd>

                                @if (!string.IsNullOrEmpty(_selectedSync.EventsSummaryJson))
                                {
                                    <dt class="col-sm-3">Events Breakdown:</dt>
                                    <dd class="col-sm-9">
                                        @{
                                            var breakdown = GetEventsSummaryBreakdown(_selectedSync.EventsSummaryJson);
                                        }
                                        <div class="small">
                                            @foreach (var item in breakdown)
                                            {
                                                <span class="badge @item.BadgeClass me-1 mb-1">@item.Text</span>
                                            }
                                        </div>
                                    </dd>
                                }

                                <dt class="col-sm-3">Records Updated:</dt>
                                <dd class="col-sm-9">
                                    <span class="@(_selectedSync.RecordsUpdated > 0 ? "text-success fw-bold" : "text-muted")">@_selectedSync.RecordsUpdated</span>
                                    <small class="text-muted ms-2">(records with actual data changes saved to database)</small>
                                </dd>

                                <dt class="col-sm-3">Records Failed:</dt>
                                <dd class="col-sm-9">@_selectedSync.RecordsFailed</dd>

                                @if (!string.IsNullOrEmpty(_selectedSync.LastEventId))
                                {
                                    <dt class="col-sm-3">Last Event ID:</dt>
                                    <dd class="col-sm-9"><code class="small">@_selectedSync.LastEventId</code></dd>
                                }

                                @if (_selectedSync.LastSyncTimestamp.HasValue)
                                {
                                    <dt class="col-sm-3">Last Sync Timestamp:</dt>
                                    <dd class="col-sm-9">@FormatLocalTime(_selectedSync.LastSyncTimestamp.Value, _selectedSync.School?.District?.LocalTimeZone, "F")</dd>
                                }

                                @if (!string.IsNullOrEmpty(_selectedSync.ErrorMessage))
                                {
                                    <dt class="col-sm-3">Error Message:</dt>
                                    <dd class="col-sm-9">
                                        <div class="alert alert-danger">
                                            <pre class="mb-0">@_selectedSync.ErrorMessage</pre>
                                        </div>
                                    </dd>
                                }
                            </dl>

                            @if (_selectedSync.RecordsProcessed > 0 && _selectedSync.RecordsUpdated == 0)
                            {
                                <div class="alert alert-info mt-3 mb-0">
                                    <strong>Why were 0 records updated?</strong>
                                    <p class="mb-2 mt-2">
                                        All @_selectedSync.RecordsProcessed records from Clever were compared against the database, but no differences were found.
                                        This is normal when data hasn't changed since the last sync.
                                    </p>
                                    <ul class="mb-0 small">
                                        <li><strong>Processed:</strong> Records fetched from Clever API and compared field-by-field</li>
                                        <li><strong>Updated:</strong> Only increments when actual data changes are detected and saved</li>
                                    </ul>
                                </div>
                            }
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseDetailsModal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-backdrop show"></div>
        }
    }
</div>

@code {
    private List<SyncHistory> _syncHistory = new();
    private List<SyncHistory> _filteredSyncHistory = new();
    private List<School> _schools = new();
    private bool _loading = true;
    private string? _error;

    // Filters
    private int _selectedSchoolId = 0;
    private string _selectedEntityType = "";
    private string _selectedStatus = "";
    private string _selectedSyncType = "";

    // Details modal
    private bool _showDetailsModal = false;
    private SyncHistory? _selectedSync;

    // FR-004: Pagination (50 records per page)
    private int _currentPage = 1;
    private const int _pageSize = 50;
    private int TotalPages => (int)Math.Ceiling(_filteredSyncHistory.Count / (double)_pageSize);

    // Orphaned sync detection
    private HashSet<string> _activeLockScopes = new();
    private int _orphanedSyncCount = 0;

    // SignalR connection for auto-refresh
    private HubConnection? _hubConnection;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        await LoadActiveLocks();
        UpdateOrphanedSyncCount();
        await InitializeSignalRConnection();
    }

    private async Task InitializeSignalRConnection()
    {
        try
        {
            // Get the authentication cookie to pass to SignalR
            var httpContext = HttpContextAccessor.HttpContext;
            var cookies = httpContext?.Request.Cookies;

            _hubConnection = new HubConnectionBuilder()
                .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/syncProgress"), options =>
                {
                    // Pass authentication cookie to SignalR connection
                    if (cookies != null)
                    {
                        options.Cookies.Add(new System.Net.Cookie(
                            ".AspNetCore.Cookies",
                            cookies[".AspNetCore.Cookies"] ?? "",
                            "/",
                            NavigationManager.ToAbsoluteUri("/").Host));
                    }
                })
                .WithAutomaticReconnect()
                .Build();

            // Listen for sync history updates and auto-refresh
            _hubConnection.On<string>("SyncHistoryUpdated", async (scope) =>
            {
                Logger.LogInformation("Received SyncHistoryUpdated notification for scope {Scope}, refreshing data", scope);
                await InvokeAsync(async () =>
                {
                    await LoadData();
                    await LoadActiveLocks();
                    UpdateOrphanedSyncCount();
                    StateHasChanged();
                });
            });

            await _hubConnection.StartAsync();
            Logger.LogInformation("SignalR connection established for Sync page auto-refresh");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to initialize SignalR connection for auto-refresh");
            // Don't fail the page load if SignalR fails - manual refresh is still available
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection != null)
        {
            await _hubConnection.DisposeAsync();
        }
    }

    private async Task LoadData()
    {
        _loading = true;
        _error = null;

        try
        {
            // Load schools based on user role
            var schoolsQuery = DbContext.Schools.AsQueryable();

            if (CurrentUser.IsSchoolAdmin && !CurrentUser.IsDistrictAdmin)
            {
                // SchoolAdmin: Only show their assigned school
                if (CurrentUser.SchoolId.HasValue)
                {
                    schoolsQuery = schoolsQuery.Where(s => s.SchoolId == CurrentUser.SchoolId.Value);
                }
                else
                {
                    _error = "Your account is not assigned to a school. Please contact an administrator.";
                    _loading = false;
                    return;
                }
            }
            else if (CurrentUser.IsDistrictAdmin && !CurrentUser.IsSuperAdmin)
            {
                // DistrictAdmin: Only show schools in their district
                if (!string.IsNullOrEmpty(CurrentUser.DistrictId))
                {
                    schoolsQuery = schoolsQuery.Where(s => s.DistrictId == CurrentUser.DistrictId);
                }
                else
                {
                    _error = "Your account is not assigned to a district. Please contact an administrator.";
                    _loading = false;
                    return;
                }
            }
            // SuperAdmin: Show all schools (no filtering)

            _schools = await schoolsQuery.OrderBy(s => s.Name).ToListAsync();

            // Load sync history for accessible schools
            var schoolIds = _schools.Select(s => s.SchoolId).ToList();

            _syncHistory = await DbContext.SyncHistory
                .Include(s => s.School)
                    .ThenInclude(school => school.District)
                .Where(s => schoolIds.Contains(s.SchoolId))
                .OrderByDescending(s => s.SyncStartTime)
                .Take(100) // Limit to last 100 syncs
                .ToListAsync();

            FilterData();
        }
        catch (Exception ex)
        {
            _error = $"Failed to load sync operations: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private void FilterData()
    {
        var filtered = _syncHistory.AsEnumerable();

        if (_selectedSchoolId > 0)
        {
            filtered = filtered.Where(s => s.SchoolId == _selectedSchoolId);
        }

        if (!string.IsNullOrEmpty(_selectedEntityType))
        {
            filtered = filtered.Where(s => s.EntityType == _selectedEntityType);
        }

        if (!string.IsNullOrEmpty(_selectedStatus))
        {
            filtered = filtered.Where(s => s.Status == _selectedStatus);
        }

        if (!string.IsNullOrEmpty(_selectedSyncType))
        {
            var syncType = Enum.Parse<SyncType>(_selectedSyncType);
            filtered = filtered.Where(s => s.SyncType == syncType);
        }

        _filteredSyncHistory = filtered.ToList();

        // FR-004: Reset to first page when filters change
        _currentPage = 1;
    }

    private async Task RefreshData()
    {
        await LoadData();
    }

    private void StartManualSync()
    {
        NavigationManager.NavigateTo("/manual-sync");
    }

    private void ViewDetails(SyncHistory sync)
    {
        _selectedSync = sync;
        _showDetailsModal = true;
    }

    private void CloseDetailsModal()
    {
        _showDetailsModal = false;
        _selectedSync = null;
    }

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalHours >= 1)
        {
            return $"{duration.TotalHours:F1}h";
        }
        else if (duration.TotalMinutes >= 1)
        {
            return $"{duration.TotalMinutes:F1}m";
        }
        else
        {
            return $"{duration.TotalSeconds:F1}s";
        }
    }

    private DateTime ConvertToLocalTime(DateTime utcTime, string? timeZoneId)
    {
        if (string.IsNullOrEmpty(timeZoneId))
        {
            timeZoneId = "Eastern Standard Time"; // Default to Eastern if not specified
        }

        try
        {
            var timeZone = TimeZoneInfo.FindSystemTimeZoneById(timeZoneId);
            return TimeZoneInfo.ConvertTimeFromUtc(utcTime, timeZone);
        }
        catch
        {
            // If timezone conversion fails, fall back to Eastern Standard Time
            var easternZone = TimeZoneInfo.FindSystemTimeZoneById("Eastern Standard Time");
            return TimeZoneInfo.ConvertTimeFromUtc(utcTime, easternZone);
        }
    }

    private string FormatLocalTime(DateTime utcTime, string? timeZoneId, string format = "g")
    {
        var localTime = ConvertToLocalTime(utcTime, timeZoneId);
        return localTime.ToString(format);
    }

    // FR-004: Pagination methods
    private IEnumerable<SyncHistory> GetPagedData()
    {
        return _filteredSyncHistory
            .Skip((_currentPage - 1) * _pageSize)
            .Take(_pageSize);
    }

    private int GetStartRecord()
    {
        if (_filteredSyncHistory.Count == 0) return 0;
        return ((_currentPage - 1) * _pageSize) + 1;
    }

    private int GetEndRecord()
    {
        var end = _currentPage * _pageSize;
        return Math.Min(end, _filteredSyncHistory.Count);
    }

    private IEnumerable<int> GetPageNumbers()
    {
        // Show up to 5 page numbers at a time
        var maxPagesToShow = 5;
        var halfMax = maxPagesToShow / 2;

        int startPage = Math.Max(1, _currentPage - halfMax);
        int endPage = Math.Min(TotalPages, startPage + maxPagesToShow - 1);

        // Adjust start if we're near the end
        if (endPage - startPage < maxPagesToShow - 1)
        {
            startPage = Math.Max(1, endPage - maxPagesToShow + 1);
        }

        return Enumerable.Range(startPage, endPage - startPage + 1);
    }

    private void GoToPage(int pageNumber)
    {
        _currentPage = Math.Max(1, Math.Min(pageNumber, TotalPages));
    }

    private void GoToFirstPage()
    {
        _currentPage = 1;
    }

    private void GoToLastPage()
    {
        _currentPage = TotalPages;
    }

    private void GoToPreviousPage()
    {
        if (_currentPage > 1)
        {
            _currentPage--;
        }
    }

    private void GoToNextPage()
    {
        if (_currentPage < TotalPages)
        {
            _currentPage++;
        }
    }

    private string GetEntityTypeLabel(string entityType)
    {
        return entityType switch
        {
            "Student" => "students",
            "Teacher" => "teachers",
            "Section" => "sections",
            "Admin" => "administrators",
            "Event" => "events",
            "Workshop" => "workshops",
            "Baseline" => "(baseline)",
            "Course" => "courses",
            _ => "records"
        };
    }

    private List<EventBreakdownItem> GetEventsSummaryBreakdown(string? eventsSummaryJson)
    {
        var result = new List<EventBreakdownItem>();
        if (string.IsNullOrEmpty(eventsSummaryJson))
            return result;

        try
        {
            var summary = System.Text.Json.JsonSerializer.Deserialize<EventsSummaryDto>(eventsSummaryJson);
            if (summary == null)
                return result;

            // Students
            if (summary.StudentCreated > 0)
                result.Add(new EventBreakdownItem { Text = $"{summary.StudentCreated} students created", BadgeClass = "bg-primary" });
            if (summary.StudentUpdated > 0)
                result.Add(new EventBreakdownItem { Text = $"{summary.StudentUpdated} students updated", BadgeClass = "bg-info" });
            if (summary.StudentDeleted > 0)
                result.Add(new EventBreakdownItem { Text = $"{summary.StudentDeleted} students deleted", BadgeClass = "bg-danger" });

            // Teachers
            if (summary.TeacherCreated > 0)
                result.Add(new EventBreakdownItem { Text = $"{summary.TeacherCreated} teachers created", BadgeClass = "bg-success" });
            if (summary.TeacherUpdated > 0)
                result.Add(new EventBreakdownItem { Text = $"{summary.TeacherUpdated} teachers updated", BadgeClass = "bg-info" });
            if (summary.TeacherDeleted > 0)
                result.Add(new EventBreakdownItem { Text = $"{summary.TeacherDeleted} teachers deleted", BadgeClass = "bg-danger" });

            // Sections
            if (summary.SectionCreated > 0)
                result.Add(new EventBreakdownItem { Text = $"{summary.SectionCreated} sections created", BadgeClass = "bg-warning text-dark" });
            if (summary.SectionUpdated > 0)
                result.Add(new EventBreakdownItem { Text = $"{summary.SectionUpdated} sections updated", BadgeClass = "bg-info" });
            if (summary.SectionDeleted > 0)
                result.Add(new EventBreakdownItem { Text = $"{summary.SectionDeleted} sections deleted", BadgeClass = "bg-danger" });

            // Skipped
            if (summary.EventsSkipped > 0)
                result.Add(new EventBreakdownItem { Text = $"{summary.EventsSkipped} skipped", BadgeClass = "bg-secondary" });
        }
        catch
        {
            // If parsing fails, return empty list
        }

        return result;
    }

    // DTOs for EventsSummary display
    private class EventBreakdownItem
    {
        public string Text { get; set; } = string.Empty;
        public string BadgeClass { get; set; } = string.Empty;
    }

    private class EventsSummaryDto
    {
        public int TotalEventsProcessed { get; set; }
        public int StudentCreated { get; set; }
        public int StudentUpdated { get; set; }
        public int StudentDeleted { get; set; }
        public int TeacherCreated { get; set; }
        public int TeacherUpdated { get; set; }
        public int TeacherDeleted { get; set; }
        public int SectionCreated { get; set; }
        public int SectionUpdated { get; set; }
        public int SectionDeleted { get; set; }
        public int EventsSkipped { get; set; }
    }

    // Orphaned sync detection methods
    private async Task LoadActiveLocks()
    {
        try
        {
            await using var dbContext = await DbContextFactory.CreateDbContextAsync();
            var activeLocks = await dbContext.SyncLocks
                .Where(l => l.ExpiresAt > DateTime.UtcNow)
                .Select(l => l.Scope)
                .ToListAsync();
            _activeLockScopes = new HashSet<string>(activeLocks);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load active locks for orphan detection");
            _activeLockScopes = new HashSet<string>();
        }
    }

    private void UpdateOrphanedSyncCount()
    {
        _orphanedSyncCount = _syncHistory.Count(s => s.Status == "InProgress" && IsOrphanedSync(s));
    }

    private bool IsOrphanedSync(SyncHistory sync)
    {
        if (sync.Status != "InProgress")
            return false;

        // Build the scope string that would be used for this sync
        var scope = $"school:{sync.SchoolId}";

        // If there's an active lock for this scope, the sync is still running
        if (_activeLockScopes.Contains(scope))
            return false;

        // Additional check: if sync started more than 2 hours ago with no lock, it's definitely orphaned
        var syncAge = DateTime.UtcNow - sync.SyncStartTime;
        if (syncAge.TotalHours > 2)
            return true;

        // For recent syncs (< 2 hours), only mark as orphaned if no lock exists
        // This handles the case where a sync just finished but hasn't updated status yet
        return true;
    }

    private async Task MarkSyncAsFailed(SyncHistory sync)
    {
        try
        {
            await using var dbContext = await DbContextFactory.CreateDbContextAsync();
            var syncToUpdate = await dbContext.SyncHistory.FindAsync(sync.SyncId);

            if (syncToUpdate != null)
            {
                syncToUpdate.Status = "Failed";
                syncToUpdate.SyncEndTime = DateTime.UtcNow;
                syncToUpdate.ErrorMessage = "Marked as failed by administrator (orphaned sync detected)";
                await dbContext.SaveChangesAsync();

                Logger.LogWarning("Marked orphaned sync {SyncId} as failed for school {SchoolId}",
                    sync.SyncId, sync.SchoolId);

                // Refresh the data
                await LoadData();
                await LoadActiveLocks();
                UpdateOrphanedSyncCount();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to mark sync {SyncId} as failed", sync.SyncId);
            _error = $"Failed to update sync status: {ex.Message}";
        }
        finally
        {
            // Ensure UI is updated after async operation completes
            StateHasChanged();
        }
    }

    private async Task MarkAllOrphanedAsFailed()
    {
        try
        {
            await using var dbContext = await DbContextFactory.CreateDbContextAsync();

            var orphanedSyncs = _syncHistory
                .Where(s => s.Status == "InProgress" && IsOrphanedSync(s))
                .Select(s => s.SyncId)
                .ToList();

            if (orphanedSyncs.Any())
            {
                var syncsToUpdate = await dbContext.SyncHistory
                    .Where(s => orphanedSyncs.Contains(s.SyncId))
                    .ToListAsync();

                foreach (var sync in syncsToUpdate)
                {
                    sync.Status = "Failed";
                    sync.SyncEndTime = DateTime.UtcNow;
                    sync.ErrorMessage = "Marked as failed by administrator (orphaned sync detected)";
                }

                await dbContext.SaveChangesAsync();

                Logger.LogWarning("Marked {Count} orphaned syncs as failed", orphanedSyncs.Count);

                // Refresh the data
                await LoadData();
                await LoadActiveLocks();
                UpdateOrphanedSyncCount();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to mark orphaned syncs as failed");
            _error = $"Failed to update sync statuses: {ex.Message}";
        }
        finally
        {
            // Ensure UI is updated after async operation completes
            StateHasChanged();
        }
    }
}
