@using CleverSyncSOS.AdminPortal.Models.ViewModels

@if (Progress != null)
{
    <div class="card mt-3">
        <div class="card-header">
            <h5 class="mb-0">Sync Progress</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-2">
                        <strong>Current Operation:</strong> @Progress.CurrentOperation
                    </p>
                    <p class="mb-2">
                        <strong>Elapsed Time:</strong> @GetElapsedTime()
                    </p>
                    @if (Progress.EstimatedTimeRemaining.HasValue)
                    {
                        <p class="mb-2">
                            <strong>Estimated Time Remaining:</strong> @FormatTimeSpan(Progress.EstimatedTimeRemaining.Value)
                        </p>
                    }
                </div>
                <div class="col-md-6">
                    @if (Progress.IsIncrementalSync)
                    {
                        @* Incremental sync shows Created/Updated/Deleted breakdown *@
                        <p class="mb-2">
                            <strong>Events:</strong> @Progress.EventsProcessed processed
                            @if (Progress.EventsSkipped > 0)
                            {
                                <span class="text-muted">(@Progress.EventsSkipped skipped)</span>
                            }
                        </p>
                        <p class="mb-2">
                            <strong>Students:</strong>
                            @if (Progress.StudentsCreated > 0)
                            {
                                <span class="text-success">@Progress.StudentsCreated created</span><text>, </text>
                            }
                            @if (Progress.StudentsUpdated > 0)
                            {
                                <span class="text-primary">@Progress.StudentsUpdated updated</span><text>, </text>
                            }
                            @if (Progress.StudentsDeleted > 0)
                            {
                                <span class="text-warning">@Progress.StudentsDeleted deleted</span>
                            }
                            @if (Progress.StudentsCreated == 0 && Progress.StudentsUpdated == 0 && Progress.StudentsDeleted == 0)
                            {
                                <span class="text-muted">no changes</span>
                            }
                        </p>
                        <p class="mb-2">
                            <strong>Teachers:</strong>
                            @if (Progress.TeachersCreated > 0)
                            {
                                <span class="text-success">@Progress.TeachersCreated created</span><text>, </text>
                            }
                            @if (Progress.TeachersUpdated > 0)
                            {
                                <span class="text-primary">@Progress.TeachersUpdated updated</span><text>, </text>
                            }
                            @if (Progress.TeachersDeleted > 0)
                            {
                                <span class="text-warning">@Progress.TeachersDeleted deleted</span>
                            }
                            @if (Progress.TeachersCreated == 0 && Progress.TeachersUpdated == 0 && Progress.TeachersDeleted == 0)
                            {
                                <span class="text-muted">no changes</span>
                            }
                        </p>
                        <p class="mb-2">
                            <strong>Sections:</strong>
                            @if (Progress.SectionsCreated > 0)
                            {
                                <span class="text-success">@Progress.SectionsCreated created</span><text>, </text>
                            }
                            @if (Progress.SectionsUpdated > 0)
                            {
                                <span class="text-primary">@Progress.SectionsUpdated updated</span><text>, </text>
                            }
                            @if (Progress.SectionsDeleted > 0)
                            {
                                <span class="text-warning">@Progress.SectionsDeleted deleted</span>
                            }
                            @if (Progress.SectionsCreated == 0 && Progress.SectionsUpdated == 0 && Progress.SectionsDeleted == 0)
                            {
                                <span class="text-muted">no changes</span>
                            }
                        </p>
                    }
                    else
                    {
                        @* Full sync shows processed/updated counts *@
                        <p class="mb-2">
                            <strong>Students:</strong>
                            @Progress.StudentsProcessed processed, @Progress.StudentsUpdated updated
                            @if (Progress.StudentsFailed > 0)
                            {
                                <span class="text-danger">(@Progress.StudentsFailed failed)</span>
                            }
                        </p>
                        <p class="mb-2">
                            <strong>Teachers:</strong>
                            @Progress.TeachersProcessed processed, @Progress.TeachersUpdated updated
                            @if (Progress.TeachersFailed > 0)
                            {
                                <span class="text-danger">(@Progress.TeachersFailed failed)</span>
                            }
                        </p>
                        @* Courses are not synced - they are district-level in Clever *@
                        <p class="mb-2">
                            <strong>Sections:</strong>
                            @Progress.SectionsProcessed processed, @Progress.SectionsUpdated updated
                            @if (Progress.SectionsFailed > 0)
                            {
                                <span class="text-danger">(@Progress.SectionsFailed failed)</span>
                            }
                        </p>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public SyncProgressUpdate? Progress { get; set; }

    private string GetElapsedTime()
    {
        if (Progress == null) return "0s";
        var elapsed = DateTime.UtcNow - Progress.StartTime;
        return FormatTimeSpan(elapsed);
    }

    private string FormatTimeSpan(TimeSpan span)
    {
        if (span.TotalHours >= 1)
        {
            return $"{(int)span.TotalHours}h {span.Minutes}m {span.Seconds}s";
        }
        else if (span.TotalMinutes >= 1)
        {
            return $"{(int)span.TotalMinutes}m {span.Seconds}s";
        }
        else
        {
            return $"{span.Seconds}s";
        }
    }
}
