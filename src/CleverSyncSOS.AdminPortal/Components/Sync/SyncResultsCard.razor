@using CleverSyncSOS.AdminPortal.Models.ViewModels

@if (Result != null)
{
    <div class="card mt-3">
        <div class="card-header @GetHeaderClass()">
            <h5 class="mb-0">
                @if (Result.Success)
                {
                    <i class="bi bi-check-circle"></i>
                    <text> Sync Completed Successfully</text>
                }
                else
                {
                    <i class="bi bi-x-circle"></i>
                    <text> Sync Failed</text>
                }
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Duration:</strong> @FormatDuration(Result.Duration)</p>
                    <p><strong>Sync Mode:</strong> @Result.SyncMode</p>
                    <p><strong>Scope:</strong> @GetScopeDescription()</p>
                </div>
                <div class="col-md-6">
                    @if (Result.Scope == "school")
                    {
                        <p>
                            <strong>Students:</strong>
                            @Result.StudentsProcessed processed,
                            @Result.StudentsFailed failed
                            @if (Result.StudentsDeleted > 0)
                            {
                                <text>, @Result.StudentsDeleted deleted</text>
                            }
                        </p>
                        <p>
                            <strong>Teachers:</strong>
                            @Result.TeachersProcessed processed,
                            @Result.TeachersFailed failed
                            @if (Result.TeachersDeleted > 0)
                            {
                                <text>, @Result.TeachersDeleted deleted</text>
                            }
                        </p>
                    }
                    else
                    {
                        <p><strong>Total Schools:</strong> @Result.TotalSchools</p>
                        <p><strong>Successful:</strong> @Result.SuccessfulSchools</p>
                        <p><strong>Failed:</strong> @Result.FailedSchools</p>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(Result.ErrorMessage))
            {
                <div class="alert alert-danger mt-3" role="alert">
                    <strong>Error:</strong> @Result.ErrorMessage
                </div>
            }

            @if (Result.SchoolResults != null && Result.SchoolResults.Any())
            {
                <hr />
                <h6>School Results</h6>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>School</th>
                            <th>Status</th>
                            <th>Students</th>
                            <th>Teachers</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var school in Result.SchoolResults)
                        {
                            <tr>
                                <td>@school.SchoolName</td>
                                <td>
                                    @if (school.Success)
                                    {
                                        <span class="badge bg-success">Success</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">Failed</span>
                                    }
                                </td>
                                <td>@school.StudentsProcessed</td>
                                <td>@school.TeachersProcessed</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }

            <div class="mt-3">
                <a href="/sync-history" class="btn btn-secondary">View Detailed History</a>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public SyncResultViewModel? Result { get; set; }

    private string GetHeaderClass()
    {
        if (Result == null) return "bg-secondary text-white";
        return Result.Success ? "bg-success text-white" : "bg-danger text-white";
    }

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalHours >= 1)
        {
            return $"{(int)duration.TotalHours}h {duration.Minutes}m {duration.Seconds}s";
        }
        else if (duration.TotalMinutes >= 1)
        {
            return $"{(int)duration.TotalMinutes}m {duration.Seconds}s";
        }
        else
        {
            return $"{duration.Seconds}s";
        }
    }

    private string GetScopeDescription()
    {
        if (Result == null) return "";

        return Result.Scope switch
        {
            "school" => $"School: {Result.SchoolName}",
            "district" => $"District (ID: {Result.DistrictId})",
            "all" => "All Districts",
            _ => Result.Scope
        };
    }
}
