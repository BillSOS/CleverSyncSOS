@using Microsoft.JSInterop
@inject IJSRuntime JS
@inject NavigationManager Navigation
@implements IAsyncDisposable

<!-- Session Timeout Warning Modal -->
@if (_showWarning)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-warning">
                <div class="modal-header bg-warning bg-opacity-10">
                    <h5 class="modal-title">
                        <i class="oi oi-clock"></i> Session Expiring Soon
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning mb-3">
                        <strong>Your session will expire in @_remainingSeconds seconds.</strong>
                    </div>
                    <p>Click "Continue Working" to extend your session, or you will be logged out automatically.</p>

                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated @GetProgressBarClass()"
                             role="progressbar"
                             style="width: @GetProgressPercentage()%"
                             aria-valuenow="@_remainingSeconds"
                             aria-valuemin="0"
                             aria-valuemax="@_warningDurationSeconds">
                            @_remainingSeconds seconds
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="Logout">
                        Logout Now
                    </button>
                    <button type="button" class="btn btn-primary" @onclick="ExtendSession">
                        <i class="oi oi-check"></i> Continue Working
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool _showWarning = false;
    private int _remainingSeconds = 0;
    private const int _sessionTimeoutMinutes = 30;  // FR-001: 30 minutes timeout
    private const int _warningMinutes = 5;          // FR-001: 5 minutes warning
    private const int _warningDurationSeconds = _warningMinutes * 60;
    private System.Threading.Timer? _countdownTimer;
    private DotNetObjectReference<SessionTimeoutWarning>? _objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _objRef = DotNetObjectReference.Create(this);

            // Initialize session timeout monitoring in JavaScript
            await JS.InvokeVoidAsync("sessionTimeout.initialize",
                _sessionTimeoutMinutes,
                _warningMinutes,
                _objRef);
        }
    }

    [JSInvokable]
    public async Task ShowWarning()
    {
        _showWarning = true;
        _remainingSeconds = _warningDurationSeconds;

        // Start countdown timer (updates every second)
        _countdownTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(() =>
            {
                _remainingSeconds--;

                if (_remainingSeconds <= 0)
                {
                    _countdownTimer?.Dispose();
                    Logout();
                }

                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));

        await InvokeAsync(StateHasChanged);
    }

    private async Task ExtendSession()
    {
        _showWarning = false;
        _countdownTimer?.Dispose();

        // Reset session timeout in JavaScript
        await JS.InvokeVoidAsync("sessionTimeout.resetTimer");

        StateHasChanged();
    }

    private void Logout()
    {
        _countdownTimer?.Dispose();
        Navigation.NavigateTo("/logout", forceLoad: true);
    }

    private string GetProgressBarClass()
    {
        if (_remainingSeconds > 180) return "bg-warning";  // > 3 minutes
        if (_remainingSeconds > 60) return "bg-orange";    // > 1 minute
        return "bg-danger";                                 // < 1 minute
    }

    private double GetProgressPercentage()
    {
        return (_remainingSeconds / (double)_warningDurationSeconds) * 100;
    }

    public async ValueTask DisposeAsync()
    {
        _countdownTimer?.Dispose();

        if (_objRef != null)
        {
            try
            {
                await JS.InvokeVoidAsync("sessionTimeout.dispose");
            }
            catch
            {
                // Ignore errors during disposal
            }
            _objRef.Dispose();
        }
    }
}
